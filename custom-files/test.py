import os
import math
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

def angle(x1,y1,x2,y2,x3,y3,x4,y4):
    dx1=x2-x1
    dx2=x4-x3
    dy1=y2-y1
    dy2=y4-y3
    angle= math.atan2(dy2,dx2) - math.atan2(dy1,dx1)
    deg =math.degrees(angle)
    if deg>180:
        deg=deg-360
    if deg<-180:
        deg=360+deg
    return deg
def angle_3_points(x1,y1,x2,y2,x3,y3):
    dx1=x2-x1
    dx2=x3-x2
    dy1=y2-y1
    dy2=y3-y2
    angle= math.atan2(dy2,dx2) - math.atan2(dy1,dx1)
    return math.degrees(angle)


def track_dir(x1, y1, x2,y2):
    return math.degrees(math.atan2(y2-y1,x2-x1))


if __name__ == "__main__":
    plt.subplots(figsize=(24, 18))
    track_points= np.array([(-0.08591620385865606, -3.177680418123087), (0.024409905076026917, -3.246441960334778),
                            (0.13473508673746287, -3.3152049903099843), (0.2801915094605647, -3.4058644771575928),
                            (0.5359713584184647, -3.5652899742126465), (0.7917564213275909, -3.7247064113616943),
                            (1.0475527048110962, -3.884101986885071), (1.3033600449562073, -4.043477416038513),
                            (1.5591624975204468, -4.202861547470093), (1.8149064779281616, -4.362352967262268),
                            (2.0705854296684265, -4.521962881088257), (2.3262104988098145, -4.681670904159546),
                            (2.5820775032043457, -4.840937376022339), (2.838320016860962, -4.999518394470215),
                            (3.0949374437332153, -5.15741491317749), (3.35110604763031, -5.316130638122559),
                            (3.605137586593628, -5.478749513626099), (3.856981039047241, -5.64536190032959),
                            (4.107739448547363, -5.813957452774048), (4.36841344833374, -5.964445352554321),
                            (4.639524459838867, -6.0958781242370605), (4.911575078964233, -6.225600481033325),
                            (5.188680410385132, -6.342194557189941), (5.482192516326904, -6.4074296951293945),
                            (5.782690048217773, -6.4219441413879395), (6.080162525177002, -6.376537561416626),
                            (6.3671336174011195, -6.286056995391847), (6.63960337638855, -6.157991886138916),
                            (6.894053936004639, -5.996865510940552), (7.130345106124878, -5.81016993522644),
                            (7.354396820068359, -5.608561038970947), (7.555838108062744, -5.384396553039551),
                            (7.753021240234375, -5.156750440597534), (7.930574178695679, -4.913207054138184),
                            (8.101697206497192, -4.665383577346802), (8.257510662078857, -4.407389163970947),
                            (8.405368328094482, -4.144995450973511), (8.540563583374023, -3.8756215572357178),
                            (8.66629934310913, -3.60193407535553), (8.781173706054688, -3.3232879638671875),
                            (8.88338851928711, -3.0399744510650635), (8.976913452148438, -2.7534594535827637),
                            (9.051152229309082, -2.4615265130996704), (9.116973876953125, -2.1675649881362915),
                            (9.156758785247803, -1.8688045144081116), (9.179831504821777, -1.5686129927635193),
                            (9.163969993591309, -1.2680144906044006), (9.099095821380615, -0.9744543731212616),
                            (8.963764667510986, -0.7058905065059662), (8.788559436798096, -0.460948146879673),
                            (8.580944061279297, -0.2425374910235405), (8.347577571868896, -0.05194370448589325),
                            (8.095683574676514, 0.1133141964673996), (7.831191539764404, 0.2578248605132103),
                            (7.560554504394531, 0.3902013562619686), (7.2875075340271, 0.5178128760308027),
                            (7.0143938064575195, 0.6452888399362564), (6.749083995819092, 0.7882895171642303),
                            (6.496149063110352, 0.9516026675701141), (6.275351524353027, 1.1557425558567047),
                            (6.107812404632568, 1.4051265120506287), (6.013416528701782, 1.6903774738311768),
                            (5.990039587020875, 1.9897390604019085), (6.047673463821411, 2.2850464582443237),
                            (6.126204967498779, 2.576031446456909), (6.206145524978638, 2.8666324615478516),
                            (6.286013603210449, 3.157251000404358), (6.347557067871094, 3.4520264863967896),
                            (6.387911081314086, 3.7503755092620796), (6.393784046173096, 4.051358461380005),
                            (6.356499910354614, 4.349872589111328), (6.266309022903442, 4.636876583099365),
                            (6.1197731494903564, 4.899580955505371), (5.925277471542358, 5.129071474075317),
                            (5.694831848144531, 5.322696924209595), (5.431572914123535, 5.467356204986572),
                            (5.137913942337036, 5.529930591583252), (4.8383920192718435, 5.506140947341917),
                            (4.5510194301605225, 5.417084455490112), (4.282683372497559, 5.280389785766602),
                            (4.03322696685791, 5.111451148986816), (3.8027634620666455, 4.917194128036494),
                            (3.587499499320984, 4.706563472747803), (3.3851640224456787, 4.483508348464966),
                            (3.195525050163269, 4.249469518661499), (3.023706078529358, 4.001846551895142),
                            (2.8565295934677124, 3.751295566558838), (2.70681095123291, 3.4897059202194214),
                            (2.5765585899353027, 3.2179394960403442), (2.4662760496139526, 2.937654495239258),
                            (2.3822180032730103, 2.648545026779175), (2.3578149676322937, 2.349166989326477),
                            (2.4532435536384583, 2.06597101688385), (2.632212996482849, 1.8242070078849792),
                            (2.842717528343198, 1.6088129878044155), (3.065426468849182, 1.4059439897537231),
                            (3.2932039499282837, 1.208578109741211), (3.521090030670166, 1.0113285183906555),
                            (3.748949408531189, 0.8140478432178497), (3.9767510890960693, 0.6167024224996567),
                            (4.202115535736084, 0.41680862568318844), (4.408918380737305, 0.19755816459655762),
                            (4.596422910690308, -0.03807620704174042), (4.743240594863892, -0.3006996437907219),
                            (4.819482088088989, -0.5907673239707947), (4.7979865074157715, -0.8903884887695312),
                            (4.701706886291504, -1.1750089228153229), (4.5314719676971436, -1.4222469925880432),
                            (4.294915437698364, -1.6072510480880737), (4.015684962272644, -1.7181545495986938),
                            (3.717794418334961, -1.7577089667320251), (3.4180954694747925, -1.7346029877662659),
                            (3.1268310546875, -1.6587885022163391), (2.854323983192444, -1.5308705568313599),
                            (2.5957515239715576, -1.3762147128582), (2.340622067451477, -1.2156961560249329),
                            (2.084897041320801, -1.0561896860599518), (1.8292534947395325, -0.8965460807085037),
                            (1.5735989809036255, -0.7369210422039032), (1.317943513393402, -0.5772971212863922),
                            (1.0622842013835907, -0.417679151520133), (0.8066202104091644, -0.2580687403678894),
                            (0.5509458631277084, -0.09847445785999298), (0.29530154168605804, 0.06116385757923126),
                            (0.03933415561914444, 0.22031784802675247), (-0.21421541646122932, 0.3830873593688011),
                            (-0.4590199515223503, 0.5589377358555794), (-0.704197347164154, 0.7342314720153809),
                            (-0.949388861656189, 0.909504622220993), (-1.1945814192295074, 1.0847760438919067),
                            (-1.4397845268249512, 1.2600349187850952), (-1.6851159930229187, 1.435130536556244),
                            (-1.9217264652252197, 1.621357023715973), (-2.1505144834518433, 1.8175610303878784),
                            (-2.379225492477417, 2.0138440132141113), (-2.594843029975891, 2.2240100502967834),
                            (-2.8020670413970947, 2.4427130222320557), (-2.982234001159668, 2.6839784383773804),
                            (-3.112987518310547, 2.954227089881897), (-3.1252994537353516, 3.252500057220459),
                            (-3.030900001525879, 3.537010073661804), (-2.844631552696228, 3.771332025527954),
                            (-2.593401551246643, 3.9356926679611206), (-2.313870906829834, 4.04692542552948),
                            (-2.026790976524353, 4.138711452484131), (-1.7397159934043884, 4.230513334274292),
                            (-1.4561800360679626, 4.331988573074341), (-1.1900933682918549, 4.471611499786377),
                            (-0.9670446813106537, 4.67184591293335), (-0.8149292171001434, 4.9298529624938965),
                            (-0.7547328770160675, 5.224005937576294), (-0.7543443515896797, 5.525429964065552),
                            (-0.8524883538484573, 5.807038307189941), (-1.0477622747421265, 6.033082008361816),
                            (-1.3082090020179749, 6.181586503982544), (-1.5889864563941956, 6.288955450057983),
                            (-1.8835519552230835, 6.351344108581543), (-2.1824555397033687, 6.386423587799072),
                            (-2.4831470251083374, 6.407022953033447), (-2.784027576446533, 6.421517372131348),
                            (-3.0854125022888184, 6.418885707855225), (-3.3867974281311035, 6.416315078735352),
                            (-3.6881885528564453, 6.415128469467163), (-3.989584445953369, 6.415268898010254),
                            (-4.290980100631714, 6.4153618812561035), (-4.592375993728638, 6.415439605712891),
                            (-4.8937718868255615, 6.415518045425415), (-5.195168972015381, 6.415632963180542),
                            (-5.496569395065308, 6.415879964828491), (-5.79766845703125, 6.406733989715576),
                            (-6.098433494567871, 6.38723611831665), (-6.398786544799805, 6.363123416900635),
                            (-6.697747468948364, 6.325377941131592), (-6.993691444396973, 6.269843578338623),
                            (-7.285714864730835, 6.195265054702759), (-7.5679895877838135, 6.093074083328247),
                            (-7.829938650131226, 5.946592092514038), (-8.038267135620117, 5.729801893234253),
                            (-8.215625524520874, 5.486565828323364), (-8.37151050567627, 5.228852987289429),
                            (-8.511319160461426, 4.962002515792847), (-8.638096809387207, 4.688665151596069),
                            (-8.75358247756958, 4.4103004932403564), (-8.855731010437012, 4.126741051673889),
                            (-8.945899963378906, 3.8392199277877808), (-9.024676322937012, 3.54842746257782),
                            (-9.090532779693604, 3.254440426826477), (-9.141397953033447, 2.9574315547943115),
                            (-9.164329051971436, 2.656906008720398), (-9.174318790435791, 2.3562389612197876),
                            (-9.149331092834473, 2.0562050342559814), (-9.074108123779297, 1.7649984955787659),
                            (-8.930992603302002, 1.5012295246124268), (-8.70540475845337, 1.3037720620632172),
                            (-8.446634769439697, 1.1496438384056091), (-8.17282485961914, 1.0241807103157043),
                            (-7.886673450469971, 0.9300671368837357), (-7.5921430587768555, 0.8667448610067368),
                            (-7.294363975524902, 0.8210071623325348), (-6.9957435131073, 0.7801983952522278),
                            (-6.697126388549805, 0.7393679246306419), (-6.403992414474487, 0.669293075799942),
                            (-6.120704412460327, 0.5676406361162663), (-5.8488733768463135, 0.43863082211464643),
                            (-5.592796325683594, 0.27976738661527634), (-5.343852519989014, 0.10739944875240326),
                            (-5.092101812362671, -0.05965524911880493), (-4.837542057037351, -0.2213906347751636),
                            (-4.580695152282715, -0.3787965625524521), (-4.32401704788208, -0.5365217849612236),
                            (-4.067820906639099, -0.6951597109436989), (-3.8121010065078735, -0.8546988815069199),
                            (-3.5565038919448853, -1.0144716799259186), (-3.300824999809265, -1.1740880608558655),
                            (-3.0450628995895386, -1.3335480690002441), (-2.7892439365386963, -1.492899477481842),
                            (-2.5334354639053345, -1.6522715091705322), (-2.277640998363495, -1.811669945716858),
                            (-2.0218599438667297, -1.971094012260437), (-1.7660804986953735, -2.130520462989807),
                            (-1.510299026966095, -2.289943039417267), (-1.254514992237091, -2.449361026287079),
                            (-0.9987292885780334, -2.6087764501571655), (-0.7429439425468445, -2.7681914567947388),
                            (-0.48715876042842865, -2.92760694026947), (-0.2313736453652382, -3.0870230197906494),
                            (-0.08591620385865606, -3.177680418123087)])
    plt.plot(track_points[:, 0], track_points[:, 1], '-o', label='Track Points')
    # plt.plot(final_df['X'],final_df['Y'],'-o')
    for i in range(track_points.shape[0]):
        plt.text(track_points[i,0], track_points[i,1], str(i))
    dif_arr =[]
    diff=0
    length= len(track_points)
    list=[]
    for i in range(0,length):
        next_point_1 = track_points[i]
        next_point_2 = track_points[(i+1)%length]
        next_point_3 = track_points[(i+2)%length]
        next_point_4 = track_points[(i+3)%length]
        next_point_5 = track_points[(i+4)%length]
        next_point_6 = track_points[(i+5)%length]
        next_point_7 = track_points[(i+6)%length]
        next_point_8 = track_points[(i+7)%length]
        prev_point_1 = track_points[(i-1+length)%length]
        prev_point_2 = track_points[(i-2+length)%length]
        angle_f2 = angle(next_point_1[0],next_point_1[1],next_point_3[0],next_point_3[1],next_point_2[0],next_point_2[1],next_point_4[0],next_point_4[1])
        angle_b2 = angle(prev_point_2[0],prev_point_2[1],next_point_1[0],next_point_1[1],prev_point_1[0],prev_point_1[1],next_point_2[0],next_point_2[1])
        angle_f3 = angle(next_point_3[0],next_point_3[1],next_point_4[0],next_point_4[1],next_point_5[0],next_point_5[1],next_point_6[0],next_point_6[1])
        angle_f4 = angle(next_point_5[0],next_point_5[1],next_point_6[0],next_point_6[1],next_point_7[0],next_point_7[1],next_point_8[0],next_point_8[1])
        angle_f = angle(next_point_1[0],next_point_1[1],next_point_2[0],next_point_2[1],next_point_3[0],next_point_3[1],next_point_4[0],next_point_4[1])
        angle_b = angle(prev_point_2[0],prev_point_2[1],prev_point_1[0],prev_point_1[1],next_point_1[0],next_point_1[1],next_point_2[0],next_point_2[1])
        angle_1= abs(math.degrees(math.atan2(next_point_2[1]-next_point_1[1],next_point_2[0]-next_point_1[0])))
        angle_2= abs(math.degrees(math.atan2(next_point_4[1]-next_point_3[1],next_point_4[0]-next_point_3[0])))
        angle_3 = angle_3_points(next_point_1[0],next_point_1[1],next_point_2[0],next_point_2[1],next_point_3[0],next_point_3[1])
        angle_4 = angle_3_points(prev_point_1[0],prev_point_1[1],next_point_1[0],next_point_1[1],next_point_2[0],next_point_2[1])
        angle_6 = angle_3_points(next_point_1[0],next_point_1[1],next_point_2[0],next_point_2[1],next_point_3[0],next_point_3[1])
        angle_7 = angle_3_points(prev_point_2[0],prev_point_2[1],prev_point_1[0],prev_point_1[1],next_point_1[0],next_point_1[1])
        angle_5= abs(math.degrees(math.atan2(prev_point_1[1]-prev_point_2[1],prev_point_1[0]-prev_point_2[0])))
        total_angle5= angle_1-angle_5
        total_angle7 = (angle_1+angle_5)/2
        total_angle6= (angle_6+angle_7)/2
        if total_angle5>180:
            total_angle5=360-total_angle5
        total_angle = angle_f-angle_b
        total_angle2= angle_2-angle_1
        total_angle3= (angle_f+angle_b)/2
        total_angle4 =(angle_4+angle_3)/2
        total_angle_f= (angle_f+angle_b+angle_f3)/3
        total_angle_f2= (angle_f+angle_b+angle_f3+angle_f4)/4
        if i==1 or (i-1+length)%length==1 or (i+1)%length ==1 or (i+2)%length ==1 or (i+3)%length ==1 or (i+4)%length ==1 or (i+5)%length ==1 or (i+6)%length ==1 or (i+7)%length==1 or (i-2+length)%length==1:
            total_angle3 =0
            total_angle4 = 0
            total_angle_f=0
            total_angle_f2 =0
        if total_angle3 >90:
            total_angle3-=180
        elif total_angle3<-90:
            total_angle3+=180
        if total_angle4 >60:
            total_angle4-=180
        elif total_angle4<-60:
            total_angle4+=180
        if total_angle6 >90:
            total_angle6-=180
        elif total_angle6<-90:
            total_angle6+=180
        if total_angle7 >90:
            total_angle7-=180
        elif total_angle7<-90:
            total_angle7+=180
        if total_angle_f >90:
            total_angle_f-=180
        elif total_angle_f<-90:
            total_angle_f+=180
        if total_angle_f2 >90:
            total_angle_f2-=180
        elif total_angle_f2<-90:
            total_angle_f2+=180
        if total_angle3>30:
            total_angle3=30
        elif total_angle3<-30:
            total_angle3=-30
        curr_track= track_dir(next_point_1[0],next_point_1[1],next_point_2[0],next_point_2[1])
        next_track = track_dir(next_point_5[0],next_point_5[1],next_point_6[0],next_point_6[1])
        dir_diff = track_dir(next_point_1[0],next_point_1[1],next_point_6[0],next_point_6[1])
        # next_track = angle(next_point_3[0],next_point_3[1],next_point_4[0],next_point_4[1],next_point_5[0],next_point_5[1],next_point_6[0],next_point_6[1])
        speed= min(4,round(5*math.tanh(8/(1+abs(total_angle3))),1))
        print(i,curr_track,next_track,(next_track-curr_track),dir_diff)
        # if not list.__contains__({"steering_angle":round(total_angle3),"speed":speed}):
        #     list.append({"steering_angle":round(total_angle3),"speed":speed})
        # print(i,total_angle5)
    # print(list)
    plt.savefig('track.png',format='png')
    plt.show()

# [3.059733510017395, 0.6826554089784622],
# [3.2095088958740234, 0.6831344813108444],
# [3.359275460243225, 0.6833638250827789],
# [3.5090349912643433, 0.6834017932415009],
# [3.6587949991226196, 0.6834610402584076],
# [3.808555006980896, 0.6835170090198517],
# [3.9583150148391724, 0.6835691034793854],
# [4.1080756187438965, 0.6836211383342743],
# [4.2578349113464355, 0.6836741119623184],
# [4.407594919204712, 0.683727964758873],
# [4.557354927062988, 0.6837812215089798],
# [4.7071144580841064, 0.6838362663984299],
# [4.856873989105225, 0.6838938742876053],
# [5.006633043289185, 0.6839521080255508],
# [5.156393527984619, 0.6840048730373383],
# [5.306154489517212, 0.6840500980615616],
# [5.455911874771118, 0.6841173022985458],
# [5.605645418167114, 0.6843366473913193],
# [5.75542140007019, 0.6842880994081497],
# [5.905304670333862, 0.6835954934358597],
# [6.055286169052124, 0.6823406517505646],
# [6.204955101013184, 0.6861690580844879],
# [6.354061603546143, 0.6985173225402832],
# [6.502514362335205, 0.7188082784414291],
# [6.643739938735962, 0.7683110386133194],
# [6.77488899230957, 0.8412670791149139],
# [6.89846134185791, 0.9262270629405975],
# [7.0100367069244385, 1.0257667303085327],
# [7.0997467041015625, 1.1460862159729004],
# [7.172473669052124, 1.2770325541496277],
# [7.230445146560669, 1.4172040224075317],
# [7.272417068481445, 1.565867006778717],
# [7.283682584762573, 1.7152734994888306],
# [7.265743970870972, 1.8636599779129024],
# [7.233960151672363, 2.010729968547821],
# [7.1842029094696045, 2.154710531234741],
# [7.114001989364624, 2.2871004343032837],
# [7.0233659744262695, 2.406221032142639],
# [6.917426347732544, 2.512663960456848],
# [6.79807996749878, 2.604923009872436],
# [6.6672019958496085, 2.6775895357131962],
# [6.526654481887817, 2.729645013809204],
# [6.380491495132446, 2.7596704959869385],
# [6.229795932769775, 2.7700384855270386],
# [6.079286813735961, 2.7733629941940308],
# [5.929529666900635, 2.7721140384674072],
# [5.7797839641571045, 2.7707979679107666],
# [5.630027532577515, 2.769605040550232],
# [5.48030161857605, 2.7690484523773193],
# [5.330573081970215, 2.768457531929016],
# [5.180745601654053, 2.765363574028015],
# [5.031071662902832, 2.766121029853821],
# [4.8823630809783936, 2.7846319675445557],
# [4.735179901123047, 2.821260929107666],
# [4.596354961395264, 2.878996968269348],
# [4.471064329147339, 2.959028959274292],
# [4.358901500701904, 3.0601580142974854],
# [4.255730390548706, 3.1701360940933228],
# [4.16035795211792, 3.2856805324554443],
# [4.066727519035339, 3.4024704694747925],
# [3.9719725847244263, 3.518454909324646],
# [3.8773505687713623, 3.6345274448394775],
# [3.7827706336975098, 3.7506459951400757],
# [3.6881529092788696, 3.86673903465271],
# [3.5935609340667725, 3.9826358556747437],
# [3.4988315105438232, 4.09949803352356],
# [3.4035515785217285, 4.217398405075073],
# [3.294981002807617, 4.319329500198364],
# [3.1679095029830933, 4.398614168167114],
# [3.0387414693832397, 4.461370468139648],
# [2.854969024658203, 4.497744560241699],
# [2.797850012779234, 4.495018482208252],
# [2.633301019668579, 4.497664451599121],
# [2.4294214248657227, 4.4980690479278564],
# [2.2890069484710693, 4.492910385131836],
# [2.1444239616394043, 4.488077163696289],
# [1.99241304397583, 4.483960390090942],
# [1.842801034450531, 4.479875564575195],
# [1.6925734877586365, 4.4749414920806885],
# [1.539882481098175, 4.468656063079834],
# [1.3862689733505262, 4.457833528518677],
# [1.2433670163154602, 4.418424367904663],
# [1.1135604083538055, 4.345951080322266],
# [0.9965091645717638, 4.250534892082216],
# [0.8920779228210449, 4.136229991912842],
# [0.8050850629806519, 4.006568551063538],
# [0.7456648498773575, 3.8689799308776855],
# [0.7141403257846834, 3.723703503608705],
# [0.7072480469942093, 3.572937488555908],
# [0.714956521987915, 3.4234429597854614],
# [0.7365620285272598, 3.275694489479065],
# [0.7720642238855366, 3.129692554473875],
# [0.8129126578569412, 2.9843615293502808],
# [0.8494300991296768, 2.838486909866333],
# [0.8816098272800446, 2.692067503929138],
# [0.9119606614112854, 2.5454180240631104],
# [0.942350447177887, 2.3987735509872437],
# [0.9727316200733185, 2.2521289587020874],
# [1.0031171143054962, 2.1054846048355103],
# [1.0335085093975067, 1.958836555480957],
# [1.063848465681076, 1.8122150301933289],
# [1.0942798256874084, 1.6655445098876953],
# [1.125132828950882, 1.518646478652954],
# [1.1569859981536865, 1.3717305064201355],
# [1.1986910104751587, 1.2280805110931396],
# [1.2531161606311798, 1.0885401666164398],
# [1.3394269943237305, 0.9674179255962372],
# [1.440102458000183, 0.8561052978038788],
# [1.5720524787902832, 0.7863914519548416],
# [1.7143170237541199, 0.7385813295841217],
# [1.862565040588379, 0.7073544710874557],
# [2.011545956134796, 0.6859170347452164],
# [2.1608630418777466, 0.6737564653158188],
# [2.3105164766311646, 0.6708721071481705],
# [2.4604655504226685, 0.6761422604322433],
# [2.610395073890686, 0.6808701455593109],
# [2.760238528251648, 0.6832202970981598],
# [2.909994959831238, 0.6831925511360168],
# [3.059733510017395, 0.6826554089784622]
